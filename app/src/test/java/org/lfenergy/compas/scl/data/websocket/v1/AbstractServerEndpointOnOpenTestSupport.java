// SPDX-FileCopyrightText: 2022 Alliander N.V.
//
// SPDX-License-Identifier: Apache-2.0
package org.lfenergy.compas.scl.data.websocket.v1;

import org.eclipse.microprofile.jwt.JsonWebToken;
import org.mockito.Mockito;

import jakarta.websocket.CloseReason;
import jakarta.websocket.Session;
import java.io.IOException;
import java.util.Set;

import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

abstract class AbstractServerEndpointOnOpenTestSupport {

    protected void testOnOpenWhenSessionCloseThrowsIOException(JsonWebToken jsonWebToken,
                                                               OnOpenInvoker onOpen) throws IOException {
        var session = Mockito.mock(Session.class);
        when(session.getId()).thenReturn("test-session-id");
        when(jsonWebToken.getGroups()).thenReturn(Set.of());
        Mockito.doThrow(new IOException("Connection reset")).when(session).close(any(CloseReason.class));

        assertDoesNotThrow(() -> onOpen.invoke(session, "SCD"));

        verify(session).close(any(CloseReason.class));
    }

    @FunctionalInterface
    protected interface OnOpenInvoker {
        void invoke(Session session, String type);
    }
}
